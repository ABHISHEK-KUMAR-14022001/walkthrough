# EKS Production Infrastructure - Complete Walkthrough

## Architecture Overview

```mermaid
graph TB
    subgraph "VPC (10.0.0.0/16)"
        subgraph "Public Subnets"
            BASTION["üñ•Ô∏è Bastion Host<br/>(SSM Access)"]
            NAT["üåê NAT Gateway"]
            IGW["üö™ Internet Gateway"]
        end
        
        subgraph "Private Subnets"
            subgraph "EKS Cluster"
                CP["üéõÔ∏è Control Plane"]
                FE["Frontend Nodes"]
                BE["Backend Nodes"]
                SYS["System Nodes"]
            end
            
            DB["üóÑÔ∏è Database VM<br/>(PostgreSQL, Redis, ES)"]
        end
    end
    
    IGW --> NAT
    NAT --> FE & BE & SYS
    BE --> DB
    FE --> DB
    BASTION --> CP
```

---

## ‚úÖ Infrastructure Status

| Component | Status | Details |
|-----------|--------|---------|
| **VPC Setup** | ‚úÖ | DNS support/hostnames enabled |
| **Public/Private Subnets** | ‚úÖ | Proper CIDR allocation with K8s load balancer tags |
| **NAT Gateway** | ‚úÖ | Enables outbound internet for private subnets |
| **EKS Cluster (v1.34)** | ‚úÖ | Private endpoint, API_AND_CONFIG_MAP auth mode |
| **Node Groups** | ‚úÖ | 3 node groups with proper taints/labels |
| **Bastion Host** | ‚úÖ | SSM-only access (no SSH ports exposed) |
| **Database VM** | ‚úÖ | Private subnet, VPC endpoints for SSM |
| **Security Groups** | ‚úÖ | PostgreSQL (5432), Redis (6379), ES (9200) from EKS nodes |
| **EKS Access** | ‚úÖ | Bastion role + devops IAM user have cluster admin |

---

## ‚úÖ Connectivity: EKS Pods ‚Üí Database VM

**Your pods can connect to the database VM successfully!**

| Service | Port | Security Group Rule | Status |
|---------|------|---------------------|--------|
| PostgreSQL | 5432 | `db_postgres_from_nodes` ‚Üí `eks_node_sg` | ‚úÖ |
| Redis | 6379 | `db_redis_from_nodes` ‚Üí `eks_node_sg` | ‚úÖ |
| Elasticsearch | 9200 | `db_elasticsearch_from_nodes` ‚Üí `eks_node_sg` | ‚úÖ |

### How to Connect from Pods

Get the database VM's private IP:
```bash
terraform output db_vm_private_ip
```

Configure your application:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-config
data:
  POSTGRES_HOST: "<db_vm_private_ip>"
  POSTGRES_PORT: "5432"
  REDIS_HOST: "<db_vm_private_ip>"
  REDIS_PORT: "6379"
  ELASTICSEARCH_HOST: "http://<db_vm_private_ip>:9200"
```

---

## Quick Start Commands

### Connect to Bastion
```bash
aws ssm start-session --target <bastion-instance-id> --region ap-south-1
```

### Configure kubectl
```bash
aws eks update-kubeconfig --region ap-south-1 --name prod-private-eks
kubectl get nodes
```

### Connect to Database VM
```bash
aws ssm start-session --target <db-instance-id> --region ap-south-1
```

---

## Security Summary

| Component | Security Measures |
|-----------|-------------------|
| **EKS Cluster** | Private endpoint only, no public access |
| **Node Groups** | Private subnets, IMDSv2 enforced, encrypted volumes (gp3) |
| **Bastion** | SSM only (no SSH), no inbound ports |
| **Database VM** | Private subnet, ingress only from EKS nodes, no public IP |
| **All Instances** | Encrypted EBS volumes, IMDSv2 required |

---

## Issues Fixed During Setup

| Issue | Fix Applied |
|-------|-------------|
| EKS Access Entry error | Added `access_config` with `API_AND_CONFIG_MAP` mode |
| kubectl authentication failed | Added EKS access entries for bastion role & devops IAM user |
| apt/docker not working on DB VM | Changed egress from VPC-only to `0.0.0.0/0` |
| SSM not working on DB VM | Added VPC endpoints for ssm, ssmmessages, ec2messages |

---

## Terraform Commands

```bash
# Initialize
terraform init

# Plan changes
terraform plan

# Apply changes
terraform apply

# View outputs
terraform output

# Destroy infrastructure
terraform destroy
```
